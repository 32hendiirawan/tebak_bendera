<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balap Sepeda Kuis</title>
    <style>
        :root { --p1-color: rgb(0,192,255); --p2-color: rgb(255,127,0); }
        body { 
            font-family: sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: linear-gradient(135deg, rgb(255,127,0), rgb(0,192,255));
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            overflow: hidden; 
            touch-action: manipulation;
            height: 100vh; 
        }
        
        /* SEMBUNYIKAN GAME DI AWAL */
        .question-area, .input-container {
            visibility: visible;
        }
        .game-visible {
            visibility: visible !important;
        }

        /* EFEK GETAR (SHAKE) */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(-1deg); }
            40% { transform: translate(3px, -1px) rotate(1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(3px, 1px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(0deg); }
        }
        .shake-active { animation: shake 0.4s; }

        .wrong-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 100px; color: rgba(231, 76, 60, 0.5); font-weight: bold;
            display: none; pointer-events: none; z-index: 10;
        }

        .race-container {
            width: 95%; max-width: 800px; background: #555; height: 120px; 
            position: relative; border: 4px solid #333; border-radius: 10px; margin: 10px 0;
        }
        .finish-line { 
            position: absolute; right: 15px; height: 100%; width: 12px; 
            background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); 
        }
        .bike { 
            position: absolute; width: 80px; z-index: 2;
            transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        #bike1 { top: 5px; left: 0; }
        #bike2 { top: 30px; left: 0; }

        .question-area {
            text-align: center; 
            background: linear-gradient(to right, rgb(0,192,255), rgb(255,127,0)); 
            padding: 5px; 
            border-radius: 10px;
            width: 800px; 
            box-shadow: 0 4px 5px rgba(0,0,0,0.3);
            display: flex;
        }
        .flag-img { height: 80px; border: 1.5px solid #ddd; margin: 5px 0; }
        .score { padding: 15px; font-weight: bold; color: white; width: 200px; border-radius: 10px; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);}

        .input-container { display: flex; width: 800px; height: 25vh; gap: 5px; padding: 5px; box-sizing: border-box; }
        .player-side { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 5px; border-radius: 12px; position: relative; }
        .p1-side { border: 4px solid var(--p1-color); background: rgba(0, 192, 255, 0.3); }
        .p2-side { border: 4px solid var(--p2-color); background: rgba(255, 127, 0, 0.3); }
        
        .btn-answer {
            border: none; border-radius: 8px; font-weight: bold; font-size: 16px;
            background: white; box-shadow: 0 3px 0 #ccc; cursor: pointer;
        }
        .btn-answer:active { transform: translateY(2px); box-shadow: none; }
        .correct { background: #2ecc71 !important; color: white; }
        .wrong { background: #e74c3c !important; color: white; }

        /* COUNTDOWN STYLES */
        #countdown-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 150px; font-weight: bold; color: #f1c40f;
            text-shadow: 4px 4px 10px rgba(0,0,0,0.3); z-index: 1000;
            display: none; pointer-events: none;
        }
        .countdown-anim { animation: pop 1s ease-out; }
        @keyframes pop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        #lock-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 900; display: none; }
    </style>
</head>
<body id="main-body">
    <div id="lock-overlay"></div>
    <div id="countdown-box"></div>

    <div id="start-menu-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1100;">
        <button onclick="startCountdown()" style="padding:20px 40px; font-size:24px; cursor:pointer; border-radius:15px; background:#2ecc71; color:white; border:none; font-weight:bold; box-shadow: 0 5px 0 #27ae60;">START</button>
    </div>

    <div class="race-container">
        <div class="finish-line"></div>
        <img id="bike1" class="bike" src="p1.gif" style="transform: scaleX(-1);">
        <img id="bike2" class="bike" src="p2.gif" style="transform: scaleX(-1);">
    </div>

    <div class="question-area">
        <div id="scoreP1" class="score">0</div>
        <div style="width: 400px;">
            <img id="flag-display" class="flag-img" src="">
        </div>
        <div id="scoreP2" class="score">0</div>
    </div>

    <div class="input-container">
        <div class="player-side p1-side" id="p1-area">
            <div id="cross-p1" class="wrong-overlay">✖</div>
            <button class="btn-answer" onclick="handleInput(0, 1)"></button>
            <button class="btn-answer" onclick="handleInput(1, 1)"></button>
            <button class="btn-answer" onclick="handleInput(2, 1)"></button>
            <button class="btn-answer" onclick="handleInput(3, 1)"></button>
        </div>
        <div class="player-side p2-side" id="p2-area">
            <div id="cross-p2" class="wrong-overlay">✖</div>
            <button class="btn-answer" onclick="handleInput(0, 2)"></button>
            <button class="btn-answer" onclick="handleInput(1, 2)"></button>
            <button class="btn-answer" onclick="handleInput(2, 2)"></button>
            <button class="btn-answer" onclick="handleInput(3, 2)"></button>
        </div>
    </div>

<script>
    let gameQuestions = [];
    let currentIdx = 0;
    let scoreP1 = 0;
    let scoreP2 = 0;
    let isLocked = false;
    let gameStarted = false;
    const WIN_SCORE = 10;

    // Data Cadangan jika JSON gagal dimuat
    const fallbackDatabase = [
        { f: "id", n: "Indonesia" }, { f: "jp", n: "Jepang" }, { f: "br", n: "Brasil" },
        { f: "fr", n: "Prancis" }, { f: "us", n: "Amerika Serikat" }, { f: "de", n: "Jerman" },
        { f: "sa", n: "Arab Saudi" }, { f: "kr", n: "Korea Selatan" }, { f: "it", n: "Italia" },
        { f: "gb", n: "Inggris" }, { f: "ca", n: "Kanada" }, { f: "au", n: "Australia" },
        { f: "ru", n: "Rusia" }, { f: "tr", n: "Turki" }, { f: "nl", n: "Belanda" },
        { f: "my", n: "Malaysia" }, { f: "sg", n: "Singapura" }, { f: "th", n: "Thailand" },
        { f: "in", n: "India" }, { f: "hk", n: "Hongkong" }, { f: "kp", n: "Korea Utara" },
        { f: "tl", n: "Timor Leste"}, { f: "ua", n: "Ukraina"}, { f: "ae", n: "Uni Emirat Arab"},
        { f: "nz", n: "Selandia Baru"}, { f: "pg", n: "Papua Nugini"}, { f: "ph", n: "Filipina"},
        { f: "pl", n: "Polandia"}, { f: "kh", n: "Kamboja"}, { f: "la", n: "Laos"},
        { f: "bn", n: "Brunei Darussalam"}, { f: "vn", n: "Vietnam"}, { f: "ps", n: "Palestina"},
    ];

    async function initGame() {
        let fullDatabase;
        try {
            const response = await fetch('soal.json');
            if (!response.ok) throw new Error('CORS or Not Found');
            fullDatabase = await response.json();
        } catch (e) {
            console.warn("Menggunakan data cadangan karena JSON gagal dimuat.");
            fullDatabase = fallbackDatabase;
        }
        
        const shuffled = [...fullDatabase].sort(() => 0.5 - Math.random());
        gameQuestions = shuffled.map(item => {
            const wrongOptions = fullDatabase
                .filter(x => x.n !== item.n)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3)
                .map(x => x.n);
            const options = [item.n, ...wrongOptions].sort(() => 0.5 - Math.random());
            return {
                flag: `https://flagcdn.com/w320/${item.f}.png`,
                options: options,
                correct: options.indexOf(item.n)
            };
        });
        loadQuestion();
    }

    function startCountdown() {
        document.getElementById('start-menu-overlay').style.display = 'none';
        const countBox = document.getElementById('countdown-box');
        const lockOverlay = document.getElementById('lock-overlay');
        let count = 3;

        countBox.style.display = 'block';
        lockOverlay.style.display = 'block';

        const interval = setInterval(() => {
            if (count > 0) {
                countBox.innerText = count;
                countBox.classList.remove('countdown-anim');
                void countBox.offsetWidth; 
                countBox.classList.add('countdown-anim');
                count--;
            } else {
                clearInterval(interval);
                countBox.innerText = "GO!";
                
                document.querySelector('.question-area').classList.add('game-visible');
                document.querySelector('.input-container').classList.add('game-visible');

                setTimeout(() => {
                    countBox.style.display = 'none';
                    lockOverlay.style.display = 'none';
                    gameStarted = true; 
                    initGame(); 
                }, 500);
            }
        }, 1000);
    }

    function loadQuestion() {
        if (gameQuestions.length === 0) return;
        isLocked = false;
        const data = gameQuestions[currentIdx];
        document.getElementById('flag-display').src = data.flag;
        document.getElementById('scoreP1').innerText = scoreP1;
        document.getElementById('scoreP2').innerText = scoreP2;
        document.getElementById('cross-p1').style.display = 'none';
        document.getElementById('cross-p2').style.display = 'none';
        
        const p1Btns = document.querySelectorAll('#p1-area .btn-answer');
        const p2Btns = document.querySelectorAll('#p2-area .btn-answer');

        data.options.forEach((opt, i) => {
            p1Btns[i].innerText = opt; 
            p1Btns[i].className = 'btn-answer';
            p2Btns[i].innerText = opt; 
            p2Btns[i].className = 'btn-answer';
        });
    }

    function handleInput(choiceIdx, player) {
        if (!gameStarted || isLocked) return;
        isLocked = true;

        const data = gameQuestions[currentIdx];
        const isCorrect = (choiceIdx === data.correct);
        const p1Btns = document.querySelectorAll('#p1-area .btn-answer');
        const p2Btns = document.querySelectorAll('#p2-area .btn-answer');

        if (player === 1) {
            if (isCorrect) { 
                scoreP1 += 1; 
                p1Btns[choiceIdx].classList.add('correct'); 
            } else { 
                scoreP2 += 0.5; 
                p1Btns[choiceIdx].classList.add('wrong'); 
                p2Btns[data.correct].classList.add('correct');
                triggerWrongEffect(1);
            }
        } else {
            if (isCorrect) { 
                scoreP2 += 1; 
                p2Btns[choiceIdx].classList.add('correct'); 
            } else { 
                scoreP1 += 0.5; 
                p2Btns[choiceIdx].classList.add('wrong'); 
                p1Btns[data.correct].classList.add('correct');
                triggerWrongEffect(2);
            }
        }

        updateBikes();

        if (scoreP1 >= WIN_SCORE || scoreP2 >= WIN_SCORE) {
            gameStarted = false;
            const winner = scoreP1 >= WIN_SCORE ? "PLAYER 1" : "PLAYER 2";
            setTimeout(() => {
                window.location.href = `win.html?winner=${encodeURIComponent(winner)}`;
            }, 500);
        } else {
            setTimeout(() => {
                currentIdx++;
                if (currentIdx >= gameQuestions.length) currentIdx = 0; 
                loadQuestion();
            }, 800);
        }
    }

    function triggerWrongEffect(playerNum) {
        const body = document.getElementById('main-body');
        body.classList.add('shake-active');
        setTimeout(() => body.classList.remove('shake-active'), 400);
        document.getElementById(`cross-p${playerNum}`).style.display = 'block';
    }

    function updateBikes() {
        const trackWidth = document.querySelector('.race-container').clientWidth - 90;
        document.getElementById('bike1').style.left = Math.min((scoreP1 / WIN_SCORE) * trackWidth, trackWidth) + 'px';
        document.getElementById('bike2').style.left = Math.min((scoreP2 / WIN_SCORE) * trackWidth, trackWidth) + 'px';
    }
</script>
</body>
</html>